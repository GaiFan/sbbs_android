package com.yuchao.ui;

import java.util.List;


import android.app.ProgressDialog;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.text.ClipboardManager;
import android.util.Log;
import android.view.ContextMenu;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.ContextMenu.ContextMenuInfo;
import android.widget.AdapterView;
import android.widget.AdapterView.AdapterContextMenuInfo;
import android.widget.LinearLayout;
import android.widget.TextView;
import android.widget.Toast;

import com.gfan.http.HttpException;
import com.gfan.sbbs.MyApplication;
import com.gfan.task2.TaskResult;
import com.gfan.ui.Adapter.TopReplyAdapter;
import com.gfan.ui.base.BaseActivity;
import com.gfan.utils.MyListView;
import com.umeng.analytics.MobclickAgent;
import com.yuchao.domain.Topic;
import com.yuchao.task.GenericTask;
import com.yuchao.task.TaskAdapter;
import com.yuchao.task.TaskListener;

public class Reply extends BaseActivity {

	public static final int REFRESH_REPLY = 1;
	public MyListView myListView;// 保存指定URL所有的回复
	private String title, boardID;
	private int id, start = 0, headPosition = 0;
	private String baseUrl, errorCause;
	private boolean isFirstLoad = true;
	private MyApplication application;

	private static final int LOADNUM = 20;

	private static final int MENU_AUTHORINFO = Menu.FIRST;
	private static final int MENU_MAIL_AUTHOR = Menu.FIRST + 1;
	private static final int MENU_REPLY = Menu.FIRST + 2;
	private static final int MENU_SHARE = Menu.FIRST + 3;
	private static final int MENU_COPY = Menu.FIRST + 4;
	private static final int MENU_SINGLE_SHARE = Menu.FIRST + 5;
	private static final int MENU_ENTER_BOARD = 0;

	private View moreView;
	private TextView moreBtn;
	private LinearLayout progressbar;
	private List<Topic> threadList;
	private TopReplyAdapter myAdapter;
	private GenericTask doRetrieveTask;

	private TaskListener mRetrieveTaskListener = new TaskAdapter() {
		private ProgressDialog pdialog;

		@Override
		public String getName() {
			return "mRetrieveTaskListener";
		}

		@Override
		public void onPreExecute(GenericTask task) {
			super.onPreExecute(task);
			if (isFirstLoad) {
				pdialog = new ProgressDialog(Reply.this);
				pdialog.setMessage(getResources().getString(R.string.loading));
				pdialog.show();
				pdialog.setCancelable(false);
			}
		}

		@Override
		public void onPostExecute(GenericTask task, TaskResult result) {
			super.onPostExecute(task, result);
			if (null != pdialog) {
				pdialog.dismiss();
			}
			myListView.onRefreshComplete();
			if (getRetrieveResult(result)) {
				isFirstLoad = false;
				draw();
				goTop();
			}
		}
	};

	@Override
	protected void _onCreate(Bundle savedInstanceState) {
		super._onCreate(savedInstanceState);
		getSupportActionBar().setDisplayHomeAsUpEnabled(true);
		setContentView(R.layout.list_without_header);
		initArgs();
		setupState();
		registerForContextMenu(myListView);
		doRetrieve();
	}

	private void initArgs() {
		id = getIntent().getExtras().getInt("id");
		boardID = getIntent().getExtras().getString("boardID");
		baseUrl = "http://bbs.seu.edu.cn/api/topic/" + boardID + "/" + id
				+ ".json?limit=" + LOADNUM;
		setTitle(getIntent().getStringExtra("title"));

		baseUrl = baseUrl.concat("&token=" + token);
		application = (MyApplication) getApplication();
		myListView = (MyListView) this.findViewById(R.id.my_list);
		moreView = getLayoutInflater().inflate(R.layout.moredata, null);
		moreBtn = (TextView) moreView.findViewById(R.id.load_more_btn);
		progressbar = (LinearLayout) moreView.findViewById(R.id.more_progress);
		myListView.addFooterView(moreView);
		myAdapter = new TopReplyAdapter(this);
		myListView.setAdapter(myAdapter);
	}

	private void setupState() {
		myListView.setonRefreshListener(new MyListView.OnRefreshListener() {

			@Override
			public void onRefresh() {
				start = 0;
				isFirstLoad = true;
				doRetrieve();
			}
		});
		moreBtn.setOnClickListener(new View.OnClickListener() {

			@Override
			public void onClick(View v) {
				doLoadMore();
			}
		});

		myListView
				.setOnItemClickListener(new AdapterView.OnItemClickListener() {

					@Override
					public void onItemClick(AdapterView<?> arg0, View arg1,
							int position, long arg3) {
						Log.i("Reply", "position is " + position);
						Topic topic = getContextItemTopic(position);
						if (null != topic) {
							Intent intent = new Intent(Reply.this,
									SinglePostActivity.class);
							intent.putExtra("topic", topic);
							startActivity(intent);
						}
					}
				});
	}

	@Override
	protected void onResume() {
		super.onResume();
		MobclickAgent.onResume(this);
	}

	@Override
	public void onPause() {
		super.onPause();
		MobclickAgent.onPause(this);
	}

	private void doRetrieve() {
		doRetrieveTask = new RetrieveTask();
		doRetrieveTask.setListener(mRetrieveTaskListener);
		String url = getBaseUrl().concat("&start=" + start);
		doRetrieveTask.execute(url);
	}

	private void doLoadMore() {
		moreBtn.setVisibility(View.GONE);
		progressbar.setVisibility(View.VISIBLE);
		doRetrieve();
	}

	private void draw() {
		myAdapter.refresh(threadList);
	}

	private void goTop() {
		myListView.setSelection(headPosition);
	}

	private Topic getContextItemTopic(int position) {
		Log.i("ReplyActivity", "position is " + position);
		if (position >= 1 && position <= myAdapter.getCount()) {
			return (Topic) myAdapter.getItem(position - 1);
		}
		return null;
	}

	@SuppressWarnings("deprecation")
	@Override
	public boolean onContextItemSelected(MenuItem item) {
		AdapterContextMenuInfo lm = (AdapterContextMenuInfo) item.getMenuInfo();
		Topic topic = getContextItemTopic(lm.position);
		switch (item.getItemId()) {
		case MENU_AUTHORINFO:// 查看作者信息
		{
			String author = topic.getAuthor();
			Intent intent = new Intent(this, ViewProfileActivity.class);
			Bundle bundle = new Bundle();
			bundle.putString("userID", author);
			intent.putExtras(bundle);
			startActivity(intent);
			break;
		}
		case MENU_MAIL_AUTHOR:// 寄信给作者
		{
			String author = topic.getAuthor();
			Intent intent = new Intent(this, WriteMail.class);
			Bundle bundle = new Bundle();
			bundle.putString(WriteMail.EXTRA_RECIEVER, author);
			bundle.putString(WriteMail.EXTRA_TITLE, topic.getTitle());
			intent.putExtras(bundle);
			startActivity(intent);
			break;
		}
		case MENU_REPLY:// 回复该帖
		{
			int id = topic.getId();
			Bundle bundle = new Bundle();
			String reTitle = "Re: ".concat(topic.getTitle());
			bundle.putString(WritePost.EXTRA_TITLE, reTitle);
			bundle.putString(WritePost.EXTRA_BOARD, boardID);
			bundle.putInt(WritePost.EXTRA_REID, id);
			bundle.putString(WritePost.EXTRA_CONTENT, topic.getContent());
			Intent intent = new Intent(this, WritePost.class);
			intent.putExtras(bundle);
			startActivity(intent);
			break;
		}
		case MENU_SINGLE_SHARE: {
			Intent intent = new Intent(Intent.ACTION_SEND);
			intent.setType("text/plain");
			String link = "http://bbs.seu.edu.cn/r/post/" + boardID + "/" + id;
			intent.putExtra(Intent.EXTRA_SUBJECT, "");
			intent.putExtra(Intent.EXTRA_TEXT,
					"#虎踞龙蟠BBS话题分享#《" + topic.getTitle() + "》:" + link);
			startActivity(Intent.createChooser(intent, getTitle()));
			break;
		}
		case MENU_SHARE: {// 同主题分享
			Intent intent = new Intent(Intent.ACTION_SEND);
			intent.setType("text/plain");
			// http://bbs.seu.edu.cn/r/topic/ID/170527
			String link = "http://bbs.seu.edu.cn/r/topic/" + boardID + "/" + id;
			intent.putExtra(Intent.EXTRA_SUBJECT, "");
			intent.putExtra(Intent.EXTRA_TEXT, "#虎踞龙蟠BBS话题分享#同主题《" + title
					+ "》:" + link);
			startActivity(Intent.createChooser(intent, getTitle()));
			break;
		}
		case MENU_COPY: {
			ClipboardManager cm = (ClipboardManager) this
					.getSystemService(Context.CLIPBOARD_SERVICE);
			cm.setText(topic.getContent());
			break;
		}
		}
		return super.onContextItemSelected(item);
	}

	@Override
	public void onCreateContextMenu(ContextMenu menu, View v,
			ContextMenuInfo menuInfo) {
		menu.setHeaderTitle("操作");
		menu.add(0, MENU_AUTHORINFO, 0, "查看作者信息");
		menu.add(0, MENU_MAIL_AUTHOR, 0, "寄信给作者");
		menu.add(0, MENU_REPLY, 0, "回复");
		menu.add(0, MENU_SINGLE_SHARE, 0, "单帖分享");
		menu.add(0, MENU_SHARE, 0, "同主题分享");
		menu.add(0, MENU_COPY, 0, "复制");
	}

	@Override
	protected void onDestroy() {

		if (doRetrieveTask != null && !doRetrieveTask.isCancelled()) {
			doRetrieveTask.cancel(true);
		}
		super.onDestroy();
	}

	public void delete(TaskResult result) {
		if (TaskResult.IO_ERROR == result) {
			Toast.makeText(this, "网络错误", Toast.LENGTH_SHORT).show();
			return;
		}
		if (TaskResult.Failed == result) {
			Toast.makeText(this, "删除失败", Toast.LENGTH_SHORT).show();
			return;
		}
		makeToast("删除成功");
		return;
	}

	public boolean getRetrieveResult(TaskResult result) {
		moreBtn.setVisibility(View.VISIBLE);
		progressbar.setVisibility(View.GONE);
		if (result == TaskResult.IO_ERROR || TaskResult.Failed == result) {
			loadFailure();
			return false;
		}
		if (TaskResult.NO_DATA == result) {
			MyApplication.makeToast("暂无数据");
			return false;
		}
		if (null == result) {
			return false;
		} else {
			return true;
		}
	}

	private void loadFailure() {
		Toast.makeText(this, errorCause, Toast.LENGTH_SHORT).show();
	}

	public void setBaseUrl(String baseUrl) {
		this.baseUrl = baseUrl;
	}

	public String getBaseUrl() {
		return baseUrl;
	}

	@Override
	public boolean onOptionsItemSelected(
			com.actionbarsherlock.view.MenuItem item) {
		switch (item.getItemId()) {
		case MENU_ENTER_BOARD:
			Intent intent = new Intent(Reply.this, TopicList.class);
			Bundle bundle = new Bundle();
			bundle.putString("boardID", boardID);
			intent.putExtras(bundle);
			startActivity(intent);
			break;
		}
		return super.onOptionsItemSelected(item);
	}

	@Override
	public boolean onCreateOptionsMenu(com.actionbarsherlock.view.Menu menu) {
		menu.add(0, MENU_ENTER_BOARD, 0, "enter board")
				.setIcon(R.drawable.ic_notification_post_read)
				.setShowAsAction(MenuItem.SHOW_AS_ACTION_IF_ROOM);
		return super.onCreateOptionsMenu(menu);
	}

	private void makeToast(String str) {
		Toast.makeText(MyApplication.mContext, str, Toast.LENGTH_SHORT).show();
	}

	private class RetrieveTask extends GenericTask {

		@Override
		protected TaskResult _doInBackground(String... params) {
			// BoardAdapter ba = SBBSSupport.getBoardTopicListAPI(params[0],
			// application.getBlackList());
			List<Topic> list;
			try {
				list = MyApplication.bbsOp.getTopicList(params[0]);
			} catch (HttpException e) {
				e.printStackTrace();
				errorCause = e.getMessage();
				return TaskResult.Failed;
			}
			// List<Topic> list = ba.getTopicList();
			if (isFirstLoad) {
				threadList = list;
				headPosition = 0;
			} else {
				headPosition = threadList.size() - 1;
				if (0 == list.size()) {
					return TaskResult.NO_DATA;
				} else {
					threadList.addAll(list);
				}
			}
			isFirstLoad = false;
			start = threadList.size();
			if (threadList.size() == 0) {
				return TaskResult.NO_DATA;
			}
			return TaskResult.OK;
		}

	}

	@Override
	protected void processUnLogin() {
		// TODO Auto-generated method stub

	}

	@Override
	protected void setup() {

	}
}
