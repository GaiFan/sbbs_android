package com.yuchao.ui;


import com.actionbarsherlock.view.Menu;
import com.actionbarsherlock.view.MenuItem;
import com.gfan.sbbs.MyApplication;
import com.gfan.sbbs.SBBSConstants;
import com.gfan.task2.TaskResult;
import com.gfan.ui.base.BaseActivity;
import com.umeng.analytics.MobclickAgent;
import com.yuchao.task.GenericTask;
import com.yuchao.task.TaskAdapter;
import com.yuchao.task.TaskListener;

import android.app.ProgressDialog;
import android.content.Context;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.inputmethod.InputMethodManager;
import android.widget.EditText;
import android.widget.LinearLayout;
import android.widget.TextView;
import android.widget.Toast;

public class Advice extends BaseActivity {
	private TextView mail_title_txt, mail_content_txt, mail_to_txt;
	private EditText titleView, contentView, recieverView;
	private GenericTask doSendTask;
	private static final int MENU_SEND = 0;
	private TaskListener mSendTaskListener = new TaskAdapter() {
		ProgressDialog pdialog;

		@Override
		public String getName() {
			return null;
		}

		@Override
		public void onPreExecute(GenericTask task) {
			super.onPreExecute(task);
			pdialog = new ProgressDialog(Advice.this);
			pdialog.setMessage("正在发送...");
			pdialog.show();
			pdialog.setCanceledOnTouchOutside(false);
		}

		@Override
		public void onPostExecute(GenericTask task, TaskResult result) {
			super.onPostExecute(task, result);
			pdialog.dismiss();
			send(result);
		}
	};

	@Override
	protected void _onCreate(Bundle savedInstanceState) {
		super._onCreate(savedInstanceState);
		getSupportActionBar().setDisplayHomeAsUpEnabled(true);
		LayoutInflater inflater = getLayoutInflater();
		LinearLayout writeMailLayout = (LinearLayout) inflater.inflate(
				R.layout.write_mail, null);
		this.setContentView(writeMailLayout);
		initView();
		init();
		setTitle("一起来抓虫");
	}

	@Override
	protected void onResume() {
		super.onResume();
		MobclickAgent.onResume(this);
	}

	@Override
	protected void onPause() {
		super.onPause();
		MobclickAgent.onPause(this);
	}

	private void initView() {
		mail_title_txt = (TextView) this.findViewById(R.id.new_mail_title_txt);
		mail_content_txt = (TextView) this
				.findViewById(R.id.new_mail_content_txt);
		titleView = (EditText) this.findViewById(R.id.new_mail_title);
		contentView = (EditText) this.findViewById(R.id.new_mail_content);
		recieverView = (EditText) this.findViewById(R.id.new_mail_to);
		mail_to_txt = (TextView) this.findViewById(R.id.write_mail_to_txt);
	}

	private void init() {
		titleView.setVisibility(View.GONE);
		mail_title_txt.setVisibility(View.GONE);
		mail_content_txt.setVisibility(View.GONE);
		recieverView.setVisibility(View.GONE);
		mail_to_txt.setVisibility(View.GONE);
	}

	public void send(TaskResult result) {
		// 关闭软键盘
		InputMethodManager imm = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);
		imm.hideSoftInputFromWindow(contentView.getWindowToken(), 0);
		if (TaskResult.Failed == result || TaskResult.IO_ERROR == result) {
			Toast.makeText(this, "发送失败", Toast.LENGTH_SHORT).show();
			return;
		}
		if (TaskResult.OK == result) {
			Toast.makeText(this, "发送成功，感谢您的支持", Toast.LENGTH_SHORT).show();
			finish();
			return;
		}
	}

	@Override
	public boolean onOptionsItemSelected(MenuItem item) {
		switch (item.getItemId()) {
		case MENU_SEND:
			String title = "虎踞龙蟠Android客户端意见反馈";
			String to = "Nine";
			String content = contentView.getText().toString().trim();
			String versionName = "v"
					+ getResources().getString(R.string.version_name);
			content = content
					.concat("\n----------------------------------\n虎踞龙蟠Android客户端 "
							+ versionName);
			doSendTask = new DoSendTask();
			doSendTask.setListener(mSendTaskListener);
			doSendTask.execute(to, title, content, "0", token);
		}
		return super.onOptionsItemSelected(item);
	}

	@Override
	public boolean onCreateOptionsMenu(Menu menu) {
		menu.add(0, MENU_SEND, 0, "send")
				.setIcon(R.drawable.ic_menu_send_holo_light)
				.setShowAsAction(MenuItem.SHOW_AS_ACTION_IF_ROOM);
		return super.onCreateOptionsMenu(menu);
	}

	@Override
	protected void onDestroy() {
		if (doSendTask != null
				&& doSendTask.getStatus() == GenericTask.Status.RUNNING) {
			doSendTask.cancel(true);
		}
		super.onDestroy();
	}

	private class DoSendTask extends GenericTask {

		@Override
		protected TaskResult _doInBackground(String... params) {
			boolean result = false;
			// 此处参数分别为收信人、邮件标题、邮件内容、reid,token
			String url = SBBSConstants.BASE_URL+"/api/mail/send.json?token="+token;
			result = MyApplication.bbsOp.doPostMail(url, params[0], params[1], params[2], params[3]);
//				result = SBBSSupport.doPostMail(params[0], params[1],
//						params[2], params[3], params[4]);
			if (result) {
				return TaskResult.OK;
			} else {
				return TaskResult.Failed;
			}
		}
	}

	@Override
	protected void processUnLogin() {

		Toast.makeText(this, "请登录后使用", Toast.LENGTH_SHORT).show();
		finish();
	}

	@Override
	protected void setup() {
		// TODO Auto-generated method stub

	}
}
