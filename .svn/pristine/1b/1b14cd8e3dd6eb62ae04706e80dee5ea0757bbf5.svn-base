package com.yuchao.ui;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;

import org.json.JSONObject;

import android.app.ProgressDialog;
import android.content.Context;
import android.content.Intent;
import android.content.pm.ActivityInfo;
import android.database.Cursor;
import android.net.Uri;
import android.os.Bundle;
import android.provider.MediaStore;
import android.provider.MediaStore.MediaColumns;
import android.text.TextUtils;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.inputmethod.InputMethodManager;
import android.widget.EditText;
import android.widget.LinearLayout;
import android.widget.TextView;
import android.widget.Toast;

import com.actionbarsherlock.ActionBarSherlock;
import com.actionbarsherlock.view.Menu;
import com.actionbarsherlock.view.MenuItem;
import com.gfan.bean.Topic;
import com.gfan.http.HttpException;
import com.gfan.sbbs.MyApplication;
import com.gfan.sbbs.SBBSConstants;
import com.gfan.task2.TaskResult;
import com.gfan.utils.StringUtils;
import com.umeng.analytics.MobclickAgent;
import com.yuchao.task.GenericTask;
import com.yuchao.task.TaskAdapter;
import com.yuchao.task.TaskListener;

public class WritePost extends com.gfan.ui.base.BaseActivity {
	private EditText titleView, contentView;
	private String boardID, reTitle, title, content, errorCause;
	private Integer reID, id;// 回复帖子id，该帖id
	private GenericTask doPostTask, doEditTask, addPhotoTask,
			mRemoveAttachmentTask;
	private Topic topic;
	private static final int TYPE_POST = 0;
	private static final int TYPE_EDIT = 1;
	private int type = 0;// 默认为发文模式
	private File mImageFile, mFile;
	private Uri mImageUri;
	private View attView;
	private TextView attItemView, attAddBtn;
	public static final String EXTRA_BOARD = "boardID";
	public static final String EXTRA_REID = "reID";
	public static final String EXTRA_ID = "id";
	public static final String EXTRA_TITLE = "title";
	public static final String EXTRA_CONTENT = "content";
	public static final String EXTRA_TOPIC = "topic_edit";

	private static final int MENU_SEND = 0;
	private static final int MENU_ADD_PHOTO = 1;
	private static final int MENU_ADD_PIC = 2;
	private static final int REQUEST_IMAGE_CAPTURE = 0;
	private static final int REQUEST_PHOTO_LIBRARY = 1;
	private static final String TAG = "WritePost";

	private TaskListener doPostListener = new TaskAdapter() {
		ProgressDialog pdialog;

		@Override
		public String getName() {
			return "doPostListener";
		}

		@Override
		public void onPreExecute(GenericTask task) {
			super.onPreExecute(task);
			pdialog = new ProgressDialog(WritePost.this);
			pdialog.setMessage("正在发送...");
			pdialog.show();
			pdialog.setCanceledOnTouchOutside(false);
		}

		@Override
		public void onPostExecute(GenericTask task, TaskResult result) {
			super.onPostExecute(task, result);
			pdialog.dismiss();
			send(result);
		}
	};

	private TaskListener doAddAttachmentTaskListener = new TaskAdapter() {
		ProgressDialog pdialog;

		@Override
		public String getName() {
			return "doAddAttachmentTaskListener";
		}

		@Override
		public void onPreExecute(GenericTask task) {
			super.onPreExecute(task);
			pdialog = new ProgressDialog(WritePost.this);
			pdialog.setMessage("正在发送...");
			pdialog.show();
			pdialog.setCanceledOnTouchOutside(false);
		}

		@Override
		public void onPostExecute(GenericTask task, TaskResult result) {
			super.onPostExecute(task, result);
			pdialog.dismiss();
			if (TaskResult.OK == result) {
				Toast.makeText(WritePost.this, "upload success",
						Toast.LENGTH_SHORT).show();
				attAddBtn.setText("删除");
				attAddBtn.setOnClickListener(new View.OnClickListener() {

					@Override
					public void onClick(View v) {
						doRemoveAttachment();
					}
				});
			} else {
				Toast.makeText(WritePost.this, "upload failure",
						Toast.LENGTH_SHORT).show();
			}
		}
	};

	private TaskListener doRemoveAttachmentTaskListener = new TaskAdapter() {
		ProgressDialog pdialog;

		@Override
		public String getName() {
			return "doRemoveAttachmentTaskListener";
		}

		@Override
		public void onPreExecute(GenericTask task) {
			super.onPreExecute(task);
			pdialog = new ProgressDialog(WritePost.this);
			pdialog.setMessage("正在删除...");
			pdialog.show();
			pdialog.setCanceledOnTouchOutside(false);
		}

		@Override
		public void onPostExecute(GenericTask task, TaskResult result) {
			super.onPostExecute(task, result);
			pdialog.dismiss();
			if (TaskResult.OK == result) {
				Toast.makeText(WritePost.this, "删除成功", Toast.LENGTH_SHORT)
						.show();
				attView.setVisibility(View.GONE);
			} else {
				Toast.makeText(WritePost.this, "删除失败", Toast.LENGTH_SHORT)
						.show();
			}
		}
	};

	@Override
	protected void _onCreate(Bundle savedInstanceState) {
		super._onCreate(savedInstanceState);
		getSupportActionBar().setDisplayHomeAsUpEnabled(true);
		ActionBarSherlock actionBar = ActionBarSherlock.wrap(this);
		actionBar
				.setUiOptions(ActivityInfo.UIOPTION_SPLIT_ACTION_BAR_WHEN_NARROW);
		LayoutInflater inflater = getLayoutInflater();
		LinearLayout newPostLayout = (LinearLayout) inflater.inflate(
				R.layout.newpost, null);
		this.setContentView(newPostLayout);
		initView();
		processArgs();

		if (reTitle != null) {
			titleView.setText(reTitle);
			contentView.requestFocus();
			contentView.setSelection(0);
			String reContent = getIntent().getExtras().getString(EXTRA_CONTENT);
			if(null != reContent){
				contentView.setHint(reContent);
			}
		}
	}

	@Override
	protected void onResume() {
		super.onResume();
		MobclickAgent.onResume(this);
	}

	private void processArgs() {
		type = getIntent().getExtras().getInt("TYPE");
		if (TYPE_POST == type) {
			boardID = getIntent().getExtras().getString(EXTRA_BOARD);
			reID = getIntent().getExtras().getInt(EXTRA_REID);
			reTitle = getIntent().getExtras().getString(EXTRA_TITLE);
			// content = getIntent().getExtras().getString("content");
			setTitle("写文章");
		} else if (TYPE_EDIT == type) {
			boardID = getIntent().getExtras().getString(EXTRA_BOARD);
			id = getIntent().getExtras().getInt(EXTRA_ID);
			reTitle = getIntent().getExtras().getString(EXTRA_TITLE);
			content = getIntent().getExtras().getString(EXTRA_CONTENT);
			contentView.setText(content);
			setTitle("编辑文章");
		}
	}

	private boolean validate() {
		title = titleView.getText().toString();
		if (TextUtils.isEmpty(title)) {
			Toast.makeText(WritePost.this, "标题不能为空", Toast.LENGTH_SHORT).show();
			return false;
		}
		if (reID == null) {
			reID = 0;
		}
		return true;
	}

	private void doPost() {
		doPostTask = new DoPostTask();
		doPostTask.setListener(doPostListener);
		content = contentView.getText().toString().trim();
		doPostTask.execute(boardID, title, content, reID.toString(), token);
	}

	private void doEdit() {
		doEditTask = new doEditTask();
		doEditTask.setListener(doPostListener);
		title = titleView.getText().toString().trim();
		content = contentView.getText().toString().trim();
		doEditTask.execute(boardID, title, content, id.toString(), token);
	}

	private void doAttachmentUpLoad() {
		addPhotoTask = new DoAddAttachment();
		addPhotoTask.setListener(doAddAttachmentTaskListener);
		addPhotoTask.execute();
	}

	private void doRemoveAttachment() {
		mRemoveAttachmentTask = new RemoveAttachmentTask();
		mRemoveAttachmentTask.setListener(doRemoveAttachmentTaskListener);
		mRemoveAttachmentTask.setCancelable(false);
		mRemoveAttachmentTask.execute();
	}

	@Override
	public void onPause() {
		super.onPause();
		MobclickAgent.onPause(this);
	}

	private void initView() {
		titleView = (EditText) this.findViewById(R.id.newpostTitle);
		contentView = (EditText) this.findViewById(R.id.newpostcontent);
		attView = this.findViewById(R.id.att_container);
		attItemView = (TextView) this.findViewById(R.id.att_id);
		attAddBtn = (TextView) this.findViewById(R.id.att_btn);
	}

	private void send(TaskResult result) {

		if (TaskResult.Failed == result) {
			Toast.makeText(this, errorCause, Toast.LENGTH_SHORT).show();
			return;
		}
		Toast.makeText(this, "发表成功", Toast.LENGTH_SHORT).show();
		Intent intent = new Intent(this, SinglePostActivity.class);
		Bundle bundle = new Bundle();
		bundle.putSerializable("topic", topic);
		intent.putExtras(bundle);
		startActivity(intent);
		finish();
	}

	@Override
	public boolean onCreateOptionsMenu(Menu menu) {
		menu.add(Menu.NONE, MENU_ADD_PHOTO, Menu.NONE, "add photo")
				.setIcon(R.drawable.toolbar_camera)
				.setShowAsAction(MenuItem.SHOW_AS_ACTION_IF_ROOM);
		menu.add(Menu.NONE, MENU_ADD_PIC, Menu.NONE, "add pic")
				.setIcon(R.drawable.toolbar_media)
				.setShowAsAction(MenuItem.SHOW_AS_ACTION_IF_ROOM);
		menu.add(0, MENU_SEND, Menu.NONE, "post")
				.setIcon(R.drawable.ic_menu_send_holo_light_inverse)
				.setShowAsAction(MenuItem.SHOW_AS_ACTION_ALWAYS);
		return true;
	}

	@Override
	public boolean onOptionsItemSelected(MenuItem item) {
		switch (item.getItemId()) {
		case MENU_SEND: {
			InputMethodManager imm = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);
			imm.hideSoftInputFromWindow(contentView.getWindowToken(), 0);
			if (validate()) {
				if (type == TYPE_POST) {
					doPost();
				} else {
					doEdit();
				}
			}
			break;
		}
		case MENU_ADD_PHOTO:
			openImageCaptureMenu();
			break;
		case MENU_ADD_PIC:

			openPhotoLibraryMenu();
			break;
		}
		return super.onOptionsItemSelected(item);
	}

	private String getPhotoFileName(Date date) {
		SimpleDateFormat dateFormat = new SimpleDateFormat("yyyyMMddKms");
		return dateFormat.format(date) + ".jpg";
	}

	protected void openImageCaptureMenu() {
		try {
			// TODO: API < 1.6, images size too small
			String filename = getPhotoFileName(new Date());
			mImageFile = new File(StringUtils.getBasePath(), filename);
			mImageUri = Uri.fromFile(mImageFile);
			Intent intent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);
			intent.putExtra(MediaStore.EXTRA_OUTPUT, mImageUri);
			startActivityForResult(intent, REQUEST_IMAGE_CAPTURE);
		} catch (Exception e) {
			Log.e(TAG, e.getMessage());
		}
	}

	protected void openPhotoLibraryMenu() {
		Intent intent = new Intent(Intent.ACTION_GET_CONTENT);
		intent.setType("image/*");
		startActivityForResult(intent, REQUEST_PHOTO_LIBRARY);
	}

	@Override
	protected void onActivityResult(int requestCode, int resultCode, Intent data) {
		super.onActivityResult(requestCode, resultCode, data);
		//TODO
		if(null == data){
			return;
		}
		if (requestCode == REQUEST_IMAGE_CAPTURE && resultCode == RESULT_OK) {
			Intent intent = new Intent(this, WritePost.class);

			// 照相完后不重新起一个WriteActivity
			getPic(intent, mImageUri);

		} else if (requestCode == REQUEST_PHOTO_LIBRARY
				&& resultCode == RESULT_OK) {
			mImageUri = data.getData();

			Intent intent = new Intent(this, WritePost.class);

			// 选图片后不重新起一个WriteActivity
			getPic(intent, mImageUri);
		}
		onPreUpLoadImage();
	}

	private void getPic(Intent intent, Uri uri) {
		mFile = null;

		mImageUri = uri;
		if (uri.getScheme().equals("content")) {// stored on the sdcard
			mFile = new File(getRealPathFromURI(mImageUri));
		} else {
			mFile = new File(mImageUri.getPath());
			Log.i(TAG, mFile.getAbsolutePath());
		}
	}

	private String getRealPathFromURI(Uri contentUri) {
		String[] proj = { MediaColumns.DATA };
		Cursor cursor = managedQuery(contentUri, proj, null, null, null);
		int column_index = cursor.getColumnIndexOrThrow(MediaColumns.DATA);
		cursor.moveToFirst();
		String path = cursor.getString(column_index);
		Log.i(TAG, "path is " + path);
		return path;
	}

	private void onPreUpLoadImage() {
		if (null == mFile) {
			return;
		}
		try {
			mFile = MyApplication.mImageLoader.getImageManager().compressImage(
					mFile, 100);
		} catch (IOException e) {
			e.printStackTrace();
		}
		attView.setVisibility(View.VISIBLE);
		attItemView.setText(mFile.getName());
		attAddBtn.setText("上传");
		attAddBtn.setOnClickListener(new View.OnClickListener() {

			@Override
			public void onClick(View arg0) {
				doAttachmentUpLoad();
			}
		});

	}

	@Override
	protected void onDestroy() {
		if (null != doPostTask
				&& doPostTask.getStatus() == GenericTask.Status.RUNNING) {
			doPostTask.cancel(true);
		}
		if (null != doEditTask
				&& doEditTask.getStatus() == GenericTask.Status.RUNNING) {
			doEditTask.cancel(true);
		}
		if (null != addPhotoTask
				&& addPhotoTask.getStatus() == GenericTask.Status.RUNNING) {
			addPhotoTask.cancel(true);
		}
		Log.d("WritePost", "activity destroyed");
		super.onDestroy();
	}

	private class DoPostTask extends GenericTask {

		@Override
		protected TaskResult _doInBackground(String... params) {
			// result = SBBSSupport.doPost(board, reid, post, title,
			// content);
			// topicAdapter = SBBSSupport.doPostAPI(params);
			String url = SBBSConstants.BASE_URL
					+ "/api/topic/post.json?type=1&token=" + token;
			try {
				topic = MyApplication.bbsOp.doPost(url, params[0], params[1],
						params[2], params[3]);
			} catch (HttpException e) {
				e.printStackTrace();
				errorCause = e.getMessage();
				return TaskResult.Failed;
			}
			return TaskResult.OK;
		}
	}

	private class DoAddAttachment extends GenericTask {

		@Override
		protected TaskResult _doInBackground(String... params) {
			try {
				mFile = MyApplication.mImageLoader.getImageManager()
						.compressImage(mFile, 100);
				Log.i(TAG, "mFile's path is " + mFile.getAbsolutePath());
			} catch (IOException e) {
				e.printStackTrace();
				return TaskResult.Failed;
			}
			String url = SBBSConstants.BASE_URL
					+ "/api/attachment/add.json?token=" + token;
			try {
				JSONObject obj = MyApplication.bbsOp.getJsonSuccess(url, mFile,
						null);
			} catch (HttpException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
				return TaskResult.Failed;
			}
			return TaskResult.OK;
		}

	}

	private class doEditTask extends GenericTask {

		@Override
		protected TaskResult _doInBackground(String... params) {
			String url = SBBSConstants.BASE_URL
					+ "/api/topic/edit.json?type=1&token=" + token;
			try {
				topic = MyApplication.bbsOp.doEdit(url, params[0], params[1],
						params[2], params[3]);
			} catch (HttpException e) {
				e.printStackTrace();
				errorCause = e.getMessage();
				return TaskResult.Failed;
			}
			return TaskResult.OK;
		}

	}

	private class RemoveAttachmentTask extends GenericTask {

		@Override
		protected TaskResult _doInBackground(String... params) {
			String url = SBBSConstants.BASE_URL
					+ "/api/attachment/delete.json?token=" + token;
			try {
				MyApplication.bbsOp.post(url, null);
			} catch (HttpException e) {
				e.printStackTrace();
				return TaskResult.Failed;
			}
			return TaskResult.OK;
		}
	}

	@Override
	protected void processUnLogin() {
		// TODO Auto-generated method stub

	}

	@Override
	protected void setup() {
		// TODO Auto-generated method stub

	}
}
